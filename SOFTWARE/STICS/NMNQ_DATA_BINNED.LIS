NMNQ_DATA_BINNED                                                25-JAN-1995 18:49:44    DEC Fortran V6.2-508                Page   1
                                                                25-JAN-1995 18:10:06    [WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.FOR;8

	      1       SUBROUTINE NMNQ_DATA_BINNED(DPPSP,DPPSM,DVSTEP,ECHN,TCHN,
	      2      .              UNQ_MAX,UMQMAX,UMQMIN,NQ,
	      3      .		    UNM_MAX,UMMAX, UMMIN, NM)
	      4 C*******************************************************************
	      5 C     This SUBROUTINE calculates ln bins for MASS and MASS/CHARGE  *
	      6 C     given the number of bins requested by the user, plus         * 
	      7 C     the status of the +/- DPPS, DV Step number, the compressed   *
	      8 C     energy channel number,and the time-of-flight channel number  *
	      9 C     for WIND-STICS. The algorithms for m, m/q are those used by  *
	     10 C     the DPU  as of July 17, 1992.                                *
	     11 C     Original version 24 Jan 95 by ABG from a routine by SChotoo. *
	     12 C     History:
	     13 C                
	     14 c*******************************************************************
	     15       IMPLICIT NONE
	     16 
	     17       REAL*4 A(6),	!mass coefficients
	     18      .       B(6),      !NM coefficients
	     19      .       C1,C2A,C2B	!mass/charge coefficients
	     20 C			 C1= time of flight **2 of 1 keV proton
	     21 C			 C2= carbon foil correction
	     22       INTEGER*4 BREAK_C2  !NQ value of C2 break point (83)
	     23       REAL*4    BREAK_MQ  !M/Q value of C2 break point (~11)
	     24 
	     25       REAL*4 D1,D2,	!E/Q coefficients, D1= analyzer constant
	     26 C			                   D2= step resolution
	     27      .       E(3)
	     28       INTEGER*4 DPPSP,  !enable bit for dpps plus plate
	     29      .          DPPSM,  !enable bit for dpps minus plate
	     30      .          DVSTEP, !deflection voltage step number 
	     31      .          ECHN    !compressed energy channel number
	     32       REAL*4 ED,        !decompressed energy channel number            
	     33      .       EMEAS,     !measured energy in keV
	     34      .       EMIN,EMAX, !measurable energy range in keV 
	     35      .       EPQ,       !E/Q
	     36      .       M,         !mass in amu
	     37      .       MPQ	!mass per charge in amu/e
	     38       INTEGER*4  NM,NQ   		   !mass bin, m/q bin
	     39       INTEGER*4  NM_MAX,  NQ_MAX, 	   !max bin values 
	     40      .           UNM_MAX, UNQ_MAX 	   !USER max bin values (-1 = use default)
	     41 
	     42       REAL*4 MMAX,  MMIN,    !measurable mass range in amu 
	     43      .       MQMAX, MQMIN,   !measurable m/q range in amu/e
	     44      .       UMMAX, UMMIN,   !USER measurable mass range in amu (-1 = use default)
	     45      .       UMQMAX,UMQMIN   !USER measurable m/q range in amu/e (-1 = use default)
	     46 
	     47       REAL*4  KM,KQ           !NM, NQ resolution parameters
	     48 
	     49    
	     50       INTEGER*4 TCHN    !time channel number
	     51       REAL*4 TEMP,         
	     52      .       TMIN,TMAX, !measurable time-of-flight range in ns
	     53      .       TOF,       !measured time-of-flight in ns
	     54      .       XX,YY
	     55 
	     56       INTEGER*4 I,J,K
	     57      

NMNQ_DATA_BINNED                                                25-JAN-1995 18:49:44    DEC Fortran V6.2-508                Page   2
                                                                25-JAN-1995 18:10:06    [WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.FOR;8

	     58 C   ***********************************************************************
	     59 C   *                    determine Nm, Nq coefficients                    *
	     60 C   ***********************************************************************
	     61 
	     62        CALL NMNQ_COEFF     (UNQ_MAX,UMQMAX,UMQMIN,    !user input
	     63      .                      UNM_MAX,UMMAX, UMMIN,
	     64      .                      EMIN,EMAX,TMIN,TMAX,      !return values
	     65      .                      NQ_MAX,MQMAX,MQMIN,
	     66      .                      NM_MAX,MMAX ,MMIN,
	     67      .                      KM,KQ,
	     68      .                      A,B,C1,C2A,C2B,D1,D2,E,
	     69      .                      BREAK_C2, BREAK_MQ)
	     70 
	     71 
	     72 
	     73 C  **************************************************************
	     74 C  *			PHA Channel number conversions	 	*
	     75 C  **************************************************************
	     76 
	     77 C     Energy Channel Number (ECHN) must first be decompressed (ED) 
	     78 C     from 9-bit to 10-bit
	     79       IF (ECHN .LT. 256) ED = ECHN
	     80       IF ((ECHN .GE. 256).AND.(ECHN .LT. 384))ED = 2.0*ECHN - 256.0 + 0.5
	     81       IF (ECHN .GE. 384) ED = 4.0*ECHN - 1024.0 + 1.5
	     82 
	     83 C     Calculate measured energy in keV from decompressed channel number
	     84       EMEAS = (ED + 6)/0.37654782
	     85 
	     86      
	     87 C     Calculate time of flight in ns from time channel number
	     88       TOF = (TCHN - 44)/2.3725306895
	     89 
	     90 
	     91 C  ******************************************************************
	     92 C  *                   E/Q, M/Q, and M algorithms                   *
	     93 C  *                   Nm, Nq values                                *
	     94 C  ******************************************************************
	     95 
	     96 C     Calculate the e/q value based on the default dpu algorithm and constants.
	     97           IF(IAND(DPPSP, DPPSM).EQ.1)THEN               !both plates on
	     98             EPQ = D1 * (D2**DVSTEP)
	     99           ELSE IF (DPPSP.EQ.1 .OR. DPPSM.EQ.1) THEN     !one plate on  
	    100             EPQ = 0.5 * D1 * (D2**DVSTEP)                
	    101           ELSE                                          !neither plate on
	    102             EPQ = 0
	    103           ENDIF
	    104 
	    105 C     Calculate mass per charge in amu/e
	    106     
	    107       MPQ = C1*(EPQ - C2A)*(TOF**2) 
	    108       IF (MPQ .GE. BREAK_MQ) MPQ = C1*(EPQ - C2B)*(TOF**2)   
	    109 
	    110       IF (TOF .GT. 0) THEN
	    111            NQ = E(1) + E(2)*ALOG(D1* (D2**DVSTEP) - C2A) +
	    112      .          E(3)*ALOG(TOF)
	    113            IF (NQ .GE. BREAK_C2)       
	    114      .      NQ = E(1) + E(2)*ALOG(D1* (D2**DVSTEP) - C2B) +

NMNQ_DATA_BINNED                                                25-JAN-1995 18:49:44    DEC Fortran V6.2-508                Page   3
                                                                25-JAN-1995 18:10:06    [WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.FOR;8

	    115      .     	 E(3)*ALOG(TOF)
	    116            IF (NQ .GT. NQ_MAX) NQ = NQ_MAX+1	!M/Q overflow
	    117            IF (NQ .LT. 1  ) NQ = 0	        !M/Q underflow
	    118       ELSE
	    119          NQ = 0
	    120       ENDIF
	    121 
	    122 C     Calculate mass in amu
	    123       IF ((EMEAS .GT. EMIN) .AND. (EMEAS .LT. EMAX) .AND.                
	    124      .    (TOF   .GT. TMIN) .AND. (TOF   .LT. TMAX) ) THEN
	    125 
	    126          XX = ALOG(EMEAS)
	    127          YY = ALOG(TOF)
	    128          TEMP = A(1) + A(2)*XX + A(3)*YY + A(4)*XX*YY
	    129          TEMP = TEMP + A(5)*XX*XX + A(6)*YY*YY*YY
	    130          M = EXP(TEMP)
	    131 
	    132          NM = B(1) + B(2)*XX + B(3)*YY + B(4)*XX*YY +
	    133      .        B(5)*XX*XX + B(6)*YY*YY*YY
	    134 
	    135          IF (NM .GE. NM_MAX) THEN
	    136               NM =  NM_MAX		!overflow mass class  (59)
	    137 	 ELSE IF (NM .LT. 1) THEN
	    138               NM =  NM_MAX + 1		!underflow mass class (60)
	    139 	 ENDIF
	    140       ELSE IF(EMEAS .LE. EMIN) THEN
	    141 	 M   = 0
	    142          NM  = 0                       !mass zero event
	    143       ELSE IF (EMEAS .GE. EMAX) THEN
	    144 	 M   = 0
	    145          NM  = NM_MAX + 2	       !energy overflow (61)
	    146       ELSE IF (TOF .LE. TMIN) THEN
	    147          M   = 0 
	    148 	 NM  = NM_MAX + 3              !time underflow (62)
	    149       ELSE IF (TOF .GE. TMAX) THEN
	    150 	 M   = 0
	    151          NM  = NM_MAX + 4              !time overflow (63)
	    152       END IF             
	    153 
	    154 
	    155       RETURN
	    156       END

NMNQ_DATA_BINNED                                                25-JAN-1995 18:49:44    DEC Fortran V6.2-508                Page   4
                                Symbol Table                    25-JAN-1995 18:10:06    [WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.FOR;8



PROGRAM SECTIONS

    Name				 Bytes   Attributes

  1 $BSS$                                  152 NOPIC CON REL LCL NOSHR NOEXE   RD   WRT OCTA
  2 $CODE$                                1332   PIC CON REL LCL   SHR   EXE NORD NOWRT OCTA
  3 $LINK$                                 148 NOPIC CON REL LCL NOSHR NOEXE   RD NOWRT OCTA

    Total Space Allocated                 1632


ENTRY POINTS

    Address   Type  Name            
                                    
  2-00000000        NMNQ_DATA_BINNED


VARIABLES

    Address   Type  Name         Address   Type  Name         Address   Type  Name         Address   Type  Name    
                                                                                                                   
  1-0000000C  I*4   BREAK_C2   1-00000024  R*4   EMAX     REG-00000024  R*4   MPQ            **      R*4   UMMAX   
  1-00000010  R*4   BREAK_MQ REG-00000022  R*4   EMEAS      1-00000038  R*4   MQMAX          **      R*4   UMMIN   
  1-00000000  R*4   C1         1-00000020  R*4   EMIN       1-0000003C  R*4   MQMIN          **      R*4   UMQMAX  
  1-00000004  R*4   C2A      REG-00000024  R*4   EPQ            **      I*4   NM             **      R*4   UMQMIN  
  1-00000008  R*4   C2B        1-00000050  I*4   I          1-00000028# I*4   NM_MAX         **      I*4   UNM_MAX 
  1-00000014  R*4   D1         1-00000054  I*4   J              **      I*4   NQ             **      I*4   UNQ_MAX 
  1-00000018  R*4   D2         1-00000058  I*4   K          1-0000002C  I*4   NQ_MAX   REG-00000025  R*4   XX      
      **      I*4   DPPSM      1-00000040  R*4   KM             **      I*4   TCHN     REG-00000020  R*4   YY      
      **      I*4   DPPSP      1-00000044  R*4   KQ             **      R*4   TEMP                                 
      **      I*4   DVSTEP         **      R*4   M          1-0000004C  R*4   TMAX                                 
      **      I*4   ECHN       1-00000030  R*4   MMAX       1-00000048  R*4   TMIN                                 
  1-0000001C  R*4   ED         1-00000034  R*4   MMIN     REG-00000023  R*4   TOF                                  


ARRAYS

     Address  Type  Name        Bytes  Dimensions

  1-0000005C  R*4   A              24  (6)
  1-00000074  R*4   B              24  (6)
  1-0000008C  R*4   E              12  (3)




NMNQ_DATA_BINNED                                                25-JAN-1995 18:49:44    DEC Fortran V6.2-508                Page   5
                                Symbol Table                    25-JAN-1995 18:10:06    [WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.FOR;8

FUNCTIONS AND SUBROUTINES REFERENCED

  Type  Name            
                        
        NMNQ_COEFF      

NMNQ_DATA_BINNED                                                25-JAN-1995 18:49:44    DEC Fortran V6.2-508                Page   6
                                Symbol Table                    25-JAN-1995 18:10:06    [WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.FOR;8



  +---------------------------------------------------+
  |               KEY TO ADDRESS CODE FORMATS         |
  |   ppp-oooooooo  - In Psect ppp, Offset oooooooo   |
  |   ***-********  - External                        |
  |               # - Suffix: Also In Registers       |
  |   REG-rrrrrrrr  - In Register rrrrrrrr            |
  |   REG-########  - In Various Registers            |
  |        **       - Not Used; Not Allocated         |
  +---------------------------------------------------+


COMMAND QUALIFIERS

  /ALIGNMENT=(COMMONS=(PACKED,NOMULTILANGUAGE),RECORDS=PACKED)
  /ASSUME=(ACCURACY_SENSITIVE,BACKSLASH,NODUMMY_ALIASES,NOUNDERSCORE)
  /CHECK=(ASSERTIONS,BOUNDS,FORMAT,FP_EXCEPTIONS,OVERFLOW,ÿÿÿ°&¶
  /DEBUG=(NOSYMBOLS,TRACEBACK)
  /DESIGN=(NOCOMMENTS)
  /SHOW=(DICTIONARY,INCLUDE,MAP,PREPROCESSOR)
  /STANDARD=(NOSEMANTIC,NOSOURCE_FORM,NOSYNTAX)
  /WARNINGS=(NOALIGNMENT,NOARGUMENT_CHECKING,NODECLARATIONS,GENERAL,NOTRUNCATED_SOURCE,UNCALLED,
             UNINITIALIZED,UNREACHABLE,UNUSED)
  /NOAUTOMATIC  /BLAS=NOMAPPED  /CONVERT=NATIVE  /NOCROSS_REFERENCE  /NOD_LINES  /ERROR_LIMIT=30  /EXTEND_SOURCE
  /NOPAD_SOURCE  /NOF77  /FLOAT=G_FLOAT  /IEEE_MODE=FAST  /ROUNDING_MODE=NEAREST
  /GRANULARITY=QUADWORD  /INSTRUCTION_SET=FLOATING  /INTEGER_SIZE=32  /NOMACHINE_CODE
  /MATH_LIBRARY=ACCURATE  /NAMES=UPPERCASE  /OPTIMIZE=(LEVEL=4,UNROLL=0)  /REAL_SIZE=32  /NORECURSIVE
  /NOSEPARATE_COMPILATION  /NOSYNCHRONOUS_EXCEPTIONS  /NOSYNTAX_ONLY  /TERMINAL=NOSTATISTICS  /NOTIE  /VMS
  /NOANALYSIS_DATA
  /NODIAGNOSTICS
  /INCLUDE=(.FOR,.f,FORT$INCLUDE:.FOR,FORT$INCLUDE:.f)
  /LIST=SMS1:[WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.LIS;4
  /OBJECT=SMS1:[WIND.SOFTWARE.STICS]NMNQ_DATA_BINNED.OBJ;5
  /NOLIBRARY
   sys$lib=SYS$COMMON:[SYSLIB]FORSYSDEF.TLB;1

COMPILER: DEC Fortran V6.2-508-274F

COMPILATION STATISTICS

  CPU time:          0.54 seconds
  Elapsed time:      2.45 seconds
  Pagefaults:         179
  I/O Count:            9
