WIND_RESET_HK                                                   30-NOV-1995 14:17:14    DEC Fortran V6.2-508                Page   1
                                                                12-APR-1995 19:05:12    SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.FOR;28

	      1       SUBROUTINE WIND_RESET_HK( sr_index )
	      2 C
	      3 C	Check if second HK is in sync with this science record.  If it is,
	      4 C	remove the first HK and adjust the HK counter.
	      5 C	Also store last HK block from this Science Record into HK block area
	      6 C	for next Science Record
	      7 C
	      8 C     Parameters:
	      9 C	sr_index  INTEGER giving index of Science Record to examine for HK
	     10 C		synchronicity.  This is one less than the science record which
	     11 C		should receive a duplicate copy of this record's last HK. 
	     12 C
	     13 C     This version:   1.9   12-APR-1995
	     14 C
	     15 C     Creation:
	     16 C	L. Bleau  9-SEP-1994
	     17 C
	     18 C     Revisions:
	     19 C	16-SEP-1994	L.Bleau		added code to check if 1st HK is dup-
	     20 C					licate and remove it if it is; change
	     21 C					meaning of parameter to which sci rec
	     22 C					to operate upon
	     23 C	20-SEP-1994	L.Bleau		made removal of first HK contingent
	     24 C					upon there being more than one HK
	     25 C       27-OCT-1994     L. Bleau        made WRITE statements to KB conditional,
	     26 C                                       added common block DIAG
	     27 C       27-OCT-1994     L. Bleau        changed name L1_sci_rec_cntr to sci_rec_cntr
	     28 C        4-NOV-1994     L. Bleau        change DO loop index to go no higher
	     29 C                                       than 5
	     30 C	13-DEC-1994	L. Bleau	replace max number of HKs (was 5) with
	     31 C					parameter MAX_HK (now 6)
	     32 C 1.7	13-JAN-1995	L. Bleau	set TIMEDIFF to 0.0 if EDB(0).SC_EPOCH
	     33 C					is zero; see comments for more details
	     34 C	 9-FEB-1995	L. Bleau	change comment delimiters
	     35 C	 9-FEB-1995	L. Bleau	change include stmt to use EDBDEF.INC
	     36 C					and EDBVARS.INC instead of EDB.INC only
	     37 C 1.8	23-FEB-1995	L. Bleau	removed common DIAG, added INCLUDE
	     38 C					DIAG.INC
	     39 C 1.9   12-APR-1995	L. Bleau	add include L1INFO.INC
	     40 CDEC$ IDENT   '1.9'
	     41 
	     42       IMPLICIT NONE
	     43  
	     44       INCLUDE	'INC_DIR:EDBDEF.INC/NOLIST'

WIND_RESET_HK                                                   30-NOV-1995 14:17:14    DEC Fortran V6.2-508                Page   2
1.9                                                             12-APR-1995 19:05:12    SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.FOR;28

	    582       INCLUDE	'INC_DIR:EDBVARS.INC/NOLIST'

WIND_RESET_HK                                                   30-NOV-1995 14:17:14    DEC Fortran V6.2-508                Page   3
1.9                                                             12-APR-1995 19:05:12    SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.FOR;28

	    764       INCLUDE	'INC_DIR:L1INFO.INC/NOLIST'
	    792       INCLUDE	'INC_DIR:DIAG.INC/NOLIST'
	    801  
	    802       INTEGER sr_index
	    803       INTEGER hk_index, II
	    804       REAL*8 TIMEDIFF
	    805 C
	    806 C Science record sr_index has the completed copy of the most recent
	    807 C science record.  It may also have an extra HK at its beginning which should
	    808 C not have been duplicated from the previous science record.
	    809 C
	    810 C This routine examines this science record and compares the times of the EDB
	    811 C and the second HK (the first HK was duplicated from the previous science
	    812 C record and is guaranteed to have a much earlier time stamp).  If the times
	    813 C reasonably match (within 1 sec) remove the first HK by copying the rest of the
	    814 C HKs down one position.  Remember to adjust the counter of number of valid HKs
	    815 C (HKset(sr_index)).
	    816 C
	    817 C We're safe accessing science record sr_index+1, by the way, since we are
	    818 C either called with a 1 or a 2 as an argument, so sr_index+1 will never be
	    819 C larger than 3, which is the number of science records kept in memory.
	    820 C
	    821 C The EDB's and the HK's are asynchronous.  Because of this, the last HK of the
	    822 C previous Science Record is copied to the first HK of the current Science
	    823 C Record by this routine.  However, as time goes on, the start times of the HK
	    824 C and the EDB will periodically come into sync for one Science Record. If the
	    825 C start times of the HK and the EDB are nearly identical, then ensure that the
	    826 C last HK of the previous science record is not repeated in this science
	    827 C record.  This is done by copying the HK records down one position and
	    828 C decrementing HK count.  If, however, for some strange reason, there is only
	    829 C one HK in the sr_index'th science record, leave it alone.
	    830 C
	    831 C NOTE: If there is no science data the SC_EPOCH field of EDB(0) will have been
	    832 C zeroed, resulting in a large value for TIMEDIFF.  This will cause an HK to
	    833 C be duplicated, which is not what is wanted.  Set TIMEDIFF to 0.0 to force the
	    834 C duplicate HK to be overwritten by later HKs.
	    835 C
	    836       TIMEDIFF = ABS(SCI(sr_index).EDB(0).SC_EPOCH - HKeep(sr_index).HKset(2).SC_EPOCH)
	    837       IF (SCI(sr_index).EDB(0).SC_EPOCH .EQ. 0.0) TIMEDIFF = 0.0
	    838       IF(DIAG .LE. 1) write(19,*) 'RESET_HK: edb,hk times=',sci(sr_index).edb(0).sc_epoch,hkeep(sr_index).hkset(2).s
	    838 c_epoch
	    839       IF(DIAG .LE. 1) write(19,*) 'RESET_HK: edb,hk time diff=',TIMEDIFF
	    840  
	    841       IF(TIMEDIFF .LT. 1000.0 .AND. HKset(sr_index) .GT. 1) THEN
	    842  
	    843         DO hk_index=2,MIN( HKset(sr_index), MAX_HK)
	    844           HKeep( sr_index ).HKSET(hk_index-1).W_TIME   = HKeep( sr_index ).HKSET(hk_index).W_TIME
	    845           HKeep( sr_index ).HKSET(hk_index-1).SC_TIME  = HKeep( sr_index ).HKSET(hk_index).SC_TIME
	    846           HKeep( sr_index ).HKSET(hk_index-1).EPOCH    = HKeep( sr_index ).HKSET(hk_index).EPOCH
	    847           HKeep( sr_index ).HKSET(hk_index-1).SC_EPOCH = HKeep( sr_index ).HKSET(hk_index).SC_EPOCH
	    848           DO II = 1, 75
	    849             HKeep( sr_index ).HKSET(hk_index-1).HK(II) = HKeep( sr_index ).HKSET(hk_index).HK(II)
	    850           END DO
	    851         END DO
	    852         IF(DIAG .LE. 1) WRITE(19,*) ' DECREMENTING HKset; was ',HKset(sr_index)
	    853         HKset( sr_index ) = HKset(sr_index) - 1
	    854         HKeep( sr_index ).HKcount = HKset( sr_index )

WIND_RESET_HK                                                   30-NOV-1995 14:17:14    DEC Fortran V6.2-508                Page   4
1.9                                                             12-APR-1995 19:05:12    SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.FOR;28

	    855       ENDIF
	    856 C 
	    857 C At this point we have a consistent science record with no duplicate HKs in the
	    858 C science record pointed to by sr_index.  The record at index sr_index+1 was
	    859 C recently vacated by a copy operation which the caller did and will be filled
	    860 C in later on.  Since we don't know at this point if the next EDB and next HK
	    861 C will be synchronous, we'll assume they will not be and save the last HK of the
	    862 C just-completed science record into the first HK position of the science record
	    863 C being formed.  This routine, when next called, will detect when the HK we
	    864 C copied over is actually a duplicate (ie, not needed) and remove it (see
	    865 C comments above), so we needn't worry about that just now.
	    866 C 
	    867       HKeep( sr_index+1 ).HKSET(1).W_TIME   = HKeep( sr_index ).HKSET(HKset(sr_index)).W_TIME
	    868       HKeep( sr_index+1 ).HKSET(1).SC_TIME  = HKeep( sr_index ).HKSET(HKset(sr_index)).SC_TIME
	    869       HKeep( sr_index+1 ).HKSET(1).EPOCH    = HKeep( sr_index ).HKSET(HKset(sr_index)).EPOCH
	    870       HKeep( sr_index+1 ).HKSET(1).SC_EPOCH = HKeep( sr_index ).HKSET(HKset(sr_index)).SC_EPOCH
	    871       DO II = 1, 75
	    872           HKeep( sr_index+1 ).HKSET(1).HK(II) = HKeep( sr_index ).HKSET(HKset(sr_index)).HK(II)
	    873       END DO
	    874  
	    875       IF(DIAG .LE. 1) WRITE(19,*) ' SCI-REC=',SCI_REC_CNTR
	    876       IF(DIAG .LE. 1) WRITE(19,*) 'RESET_HK: MOVING LAST HK TO NEXT SCI REC, COPIED FROM HK INDEX=',HKset(sr_index)
	    877       HKset(sr_index+1) = 1
	    878       IF(DIAG .LE. 1) write(19,*) 'RESET_HK: HKset array=',(hkset(ii),ii=1,3)
	    879       RETURN
	    880       END


PROGRAM SECTIONS

    Name				 Bytes   Attributes

  1 $DATA$                                  24 NOPIC CON REL LCL NOSHR NOEXE   RD   WRT OCTA
  2 $BSS$                                    8 NOPIC CON REL LCL NOSHR NOEXE   RD   WRT OCTA
  3 $CODE$                                2652   PIC CON REL LCL   SHR   EXE NORD NOWRT OCTA
  4 $LINK$                                 362 NOPIC CON REL LCL NOSHR NOEXE   RD NOWRT OCTA
  5 EDB                                 454336 NOPIC OVR REL GBL NOSHR NOEXE   RD   WRT OCTA
  6 EDB_HEADER                              20 NOPIC OVR REL GBL NOSHR NOEXE   RD   WRT OCTA
  7 HDB                                    996 NOPIC OVR REL GBL NOSHR NOEXE   RD   WRT OCTA
  8 HK                                    3912 NOPIC OVR REL GBL NOSHR NOEXE   RD   WRT OCTA
  9 L1INFO                                  40 NOPIC OVR REL GBL NOSHR NOEXE   RD   WRT OCTA
 10 DIAG                                    48 NOPIC OVR REL GBL NOSHR NOEXE   RD   WRT OCTA

    Total Space Allocated               462398


ENTRY POINTS

    Address   Type  Name         
                                 
  3-00000000        WIND_RESET_HK



WIND_RESET_HK                                                   30-NOV-1995 14:17:14    DEC Fortran V6.2-508                Page   5
1.9                             Symbol Table                    12-APR-1995 19:05:12    SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.FOR;28

VARIABLES

    Address   Type  Name                    Address   Type  Name                    Address   Type  Name               
                                                                                                                       
  6-00000006  L*1   BITRATE             REG-########  I*4   II                    6-00000010  I*4   SPINCOUNT          
  9-00000014  I*4   CURR_SCI_REC_NUMBER  10-00000004  L*4   INTER                     **      I*4   SR_INDEX           
  9-00000018  I*4   CURR_SPIN             9-00000004  I*4   L1_RECS_WRITTEN       6-00000009  L*1   STICSPOWER         
 10-00000000  I*4   DIAG                 10-00000010  CHAR  LINK_DATE_TIME        1-00000008  I*4   STICS_H_RATE_SIZE  
  5-0006EEBC  I*4   EDBSET                6-00000008  L*1   MASSPOWER             1-0000000C  I*4   STICS_N_RATE_SIZE  
  1-00000000  I*4   EDB_CORE_SIZE         1-00000004  I*4   MASS_RATE_SIZE        2-00000000  I*4   STICS_RATE_SIZE    
  9-00000008  I*4   EDB_LOST              6-0000000C  I*4   MEASSPIN              6-00000004  L*1   SUBS_ID            
  9-0000000C  I*4   EDB_SKIP              9-0000001C  L*4   NEW_SCI_REC           6-00000007  L*1   SWICSPOWER         
  9-00000010  I*4   EDB_SUM              10-00000008  L*4   NRT_MODE              1-00000010  I*4   SWICS_H_RATE_SIZE  
  9-00000020  L*4   EPH_AVAIL            10-0000000C  L*4   PRINTLZ_MODE          1-00000014  I*4   SWICS_N_RATE_SIZE  
  9-00000024  L*4   FROM_CD              10-00000027  CHAR  PROG_VERSION          2-00000004  I*4   SWICS_RATE_SIZE    
 10-0000002C  L*4   HALT_IF_NO_EPH        6-0000000A  L*1   RAMCHECK              0-00000038# R*8   TIMEDIFF           
  6-00000005  L*1   HDBFLAG               9-00000000  I*4   SCI_REC_CNTR                                               
REG-00000017  I*4   HK_INDEX              6-00000000  I*4   SFPERBLOCK                                                 


ARRAYS

     Address  Type  Name             Bytes  Dimensions

  5-00005688  I*1   CORE_DATA         1980  (0:10, 0:59, 3)
  7-000003CC  I*4   HDBTIME2            24  (2, 3)
  8-00000CF0  I*4   HKLOCI             300  (75)
  8-00000E1C  I*4   HKLOCJ             300  (75)
  8-00000CE4  I*4   HKSET               12  (3)
  6-0000000B  L*1   SPARFLAGS            1  (1)



RECORD ARRAYS

    Address   Name        Structure         Bytes  Dimensions

  7-00000000  HDB         HDBSTR             972  (3)
  8-00000000  HKEEP       HKEEP             3300  (3)
  5-0004D424  MASS_PHA    MA_PHA          137880  (3)
  5-0004BDA4  MASS_RATE   MA_RATE           5760  (3)
  5-00000000  SCI         CORE             22152  (3)
  5-00030F54  STICS_PHA   ST_PHA          110160  (3)
  5-00028DF4  STICS_RATE  ST_RATE          33120  (3)
  5-0000B2A4  SWICS_PHA   SW_PHA          121680  (3)
  5-00005E44  SWICS_RATE  SW_RATE          21600  (3)


WIND_RESET_HK                                                   30-NOV-1995 14:17:14    DEC Fortran V6.2-508                Page   6
1.9                             Symbol Table                    12-APR-1995 19:05:12    SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.FOR;28



  +---------------------------------------------------+
  |               KEY TO ADDRESS CODE FORMATS         |
  |   ppp-oooooooo  - In Psect ppp, Offset oooooooo   |
  |   ***-********  - External                        |
  |               # - Suffix: Also In Registers       |
  |   REG-rrrrrrrr  - In Register rrrrrrrr            |
  |   REG-########  - In Various Registers            |
  |        **       - Not Used; Not Allocated         |
  +---------------------------------------------------+


COMMAND QUALIFIERS

  /ALIGNMENT=(COMMONS=(PACKED,NOMULTILANGUAGE),RECORDS=PACKED)
  /ASSUME=(ACCURACY_SENSITIVE,BACKSLASH,NODUMMY_ALIASES,NOUNDERSCORE)
  /CHECK=(ASSERTIONS,BOUNDS,FORMAT,FP_EXCEPTIONS,OVERFLOW,ÿÿÿ°&¶
  /DEBUG=(NOSYMBOLS,TRACEBACK)
  /DESIGN=(NOCOMMENTS)
  /SHOW=(DICTIONARY,INCLUDE,MAP,PREPROCESSOR)
  /STANDARD=(NOSEMANTIC,NOSOURCE_FORM,NOSYNTAX)
  /WARNINGS=(NOALIGNMENT,NOARGUMENT_CHECKING,DECLARATIONS,GENERAL,NOTRUNCATED_SOURCE,UNCALLED,
             UNINITIALIZED,UNREACHABLE,UNUSED)
  /NOAUTOMATIC  /BLAS=NOMAPPED  /CONVERT=NATIVE  /NOCROSS_REFERENCE  /NOD_LINES  /ERROR_LIMIT=30  /EXTEND_SOURCE
  /NOPAD_SOURCE  /NOF77  /FLOAT=G_FLOAT  /IEEE_MODE=FAST  /ROUNDING_MODE=NEAREST
  /GRANULARITY=QUADWORD  /INSTRUCTION_SET=FLOATING  /INTEGER_SIZE=32  /NOMACHINE_CODE
  /MATH_LIBRARY=ACCURATE  /NAMES=UPPERCASE  /OPTIMIZE=(LEVEL=4,UNROLL=0)  /REAL_SIZE=32  /NORECURSIVE
  /NOSEPARATE_COMPILATION  /NOSYNCHRONOUS_EXCEPTIONS  /NOSYNTAX_ONLY  /TERMINAL=NOSTATISTICS  /NOTIE  /VMS
  /NOANALYSIS_DATA
  /NODIAGNOSTICS
  /INCLUDE=(.FOR,.f,FORT$INCLUDE:.FOR,FORT$INCLUDE:.f)
  /LIST=SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.LIS;79
  /OBJECT=SMS1:[WIND.SOFTWARE.LZ]WIND_RESET_HK.OBJ;41
  /NOLIBRARY
   sys$lib=SYS$COMMON:[SYSLIB]FORSYSDEF.TLB;1

COMPILER: DEC Fortran V6.2-508-274F

COMPILATION STATISTICS

  CPU time:          1.37 seconds
  Elapsed time:      3.16 seconds
  Pagefaults:         258
  I/O Count:           28
